<style>

    .title-holder {
        margin-top: 52px;
    }

    .return-form-suport {
        font-family: 'Public Sans';
        font-style: normal;
        font-weight: 700;
        font-size: 22px;
        line-height: 26px;
        text-decoration: underline;
        color: #006546;
        padding: 24px 0 24px;
    }

    .container-spacer-bottom {
        height:10rem;
    }

    .category-forms-container {
        height: fit-content;
        width: 100%;
        padding: 1rem;
        margin: 0 0 2rem 0;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 96px;
    }

    .category-forms-container-reuired {
        width: 100%;
        height: fit-content;
    }
        .category-forms-holder-title {
            font-family: 'Public Sans';
            font-style: normal;
            font-weight: 700;
            font-size: 22px;
            line-height: 26px;
            color: #000000;
            margin: 24px 0 8px
        }
        .category-forms-holder-message {
            font-family: 'Public Sans';
            font-style: normal;
            font-weight: 400;
            font-size: 16px;
            line-height: 18px;
            color: #212121;
            margin-bottom: 16px;
        }

        .category-forms-holder {
            width: 100%;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 2rem;
        }

        .category-forms-card {
            max-width: 30%;
            height: 1fr;
            border: 1px solid #BBBBBB;
            border-top: 5px solid #006546;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
            .category-forms-card-content {
                max-width: 100%;
                height: 100%;
                margin: 0px;
                flex: 0 0 100%;
            }

            .form-name {
                font-family: 'Public Sans';
                font-style: bold;
                font-weight: 400;
                font-size: 18px;
                line-height: 18px;
                color: #006546;
                margin: 24px 0 8px;
                padding: 0 16px;
            }
            
            .form-description-text {
                font-family: 'Public Sans';
                font-style: normal;
                font-weight: 400;
                font-size: 16px;
                line-height: 18px;
                color: #212121;
                margin-bottom: 16px;
                min-height: 100%;
                margin: 24px 0 ;
                padding: 0 16px;
            }

            .required {
                background: #006546;
                color: #FFFFFF;
                font-family: 'Public Sans';
                font-style: normal;
                font-weight: 400;
                font-size: 16px;
                line-height: 40px;
                display: flex;
                justify-content: center;
                align-items: center;
                text-align: center;
            }

            .recomended {
                background: #DBEDE0;
                color: #212121;
                font-weight: 400;
                font-family: 'Public Sans';
                font-style: normal;
                font-size: 16px;
                line-height: 40px;
                display: flex;
                justify-content: center;
                align-items: center;
                text-align: center;
            }

            .additional {
                background: #F7F7F7;
                color: #111221;
                font-family: 'Public Sans';
                font-style: normal;
                font-weight: 400;
                font-size: 16px;
                line-height: 40px;
                display: flex;
                justify-content: center;
                align-items: center;
                text-align: center;
            }
    .button-container {
        display: flex;
        flex-direction: row;
        column-gap: 8px;
        margin-bottom: 24px;
        padding: 0 16px;
    }
        .button-holder {
            border-radius: 4px;
            font-family: 'Public Sans';
            font-style: bold;
            font-weight: 700;
            font-size: 16px;
            line-height: 20px;
            text-align: center;
            max-width: 50%;
            padding: 1rem;
        }
        .button-blue {
            background: #1A6AD3;
            color: #FFFFFF;
        }
        .button-white {
            background-color: #FFFFFF;
            border: 2px solid #1A6AD3;
            color: #1A6AD3;
        }

</style>

<div id="main-content" id="body"> 
    <!-- Tiles Text --> 
    <div class="container">
        <div class="row">
            <div class="primary-region medium-12">
                <h1 class="primary-region__title title-holder" id="title-holder"> <!-- calculated in script --> </h1>
            </div>
        </div>
    </div>

    <!-- List of conditions--> 
    <div class="container">
        <div class="farmers-landing-page row">
            <div class="primary-region medium-12" id="primary-region">
                <div class="primary-region__header" >
                    <div id="header-holder"> </div>
                    <div id="header-info-holder"> 
                        <p id="header-note"></p>
                        <ul>
                            <li>The forms can only be saved to your computer;</li>
                            <li>At no point in this process is any information saved to, or shared with USDA staff or systems; and</li>
                            <li>You care encouraged to reach out to your Local Service Center if you have any further questions or concerns.</li>
                        </ul>
                        <div class="return-form-suport" id="return-form-suport"></div>
                        <!-- Yellow warning --> 
                        <div class="warning-container">
                            <div class="warning-left-bar"> </div>
                            <div class="warning-icon">
                                <img src="./images/alerts/warning.png" alt="warning icon" height="32" width="32">
                            </div>
                            <div class="warning-message">
                                <div class="warning-message-title">
                                    These forms can only be saved to your computer
                                </div>
                            </div>
                        </div>
                        
                        <!-- blue  info box --> 
                        <div class="flag"><div class="flag-leftbar"></div><div class="flag-iconholder"><img src="./images/alerts/info.png"></div><div class="flag-text"><div class="flag-text-title">Take the Farm Loan Quiz</div><div class="flag-text-message">Not sure where to start? Complete the FSA Farm Loan Quiz to understand which loan best suits your needs.</div><button class="flag-button">GET STARTED</button></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="divider-line"></div>
    </div>

    <!-- Holds contents based on conditions -->
    <div class="container">
        <div class="container-card-holder"id="forms-holder"></div>
    </div>
    <div class="container-spacer-bottom"></div>
</div>

<script>
    var forms = [];
    var loanTypes = [];
    var categories = [];

    (function() {
        $.getJSON("/forms/forms.json", function(formData) {
            forms = [...formData['Forms']];
            $.getJSON("/forms/loantypes.json", function(data) {
                loanTypes = [...data['loanType']];
                categories = [...data['categories']];

                if(getSearchQuerry() != undefined && getSearchQuerry() != "") {
                    showSearchResults();
                    return;
                }
                
                // Get the current page
                var loanType = getloanType();
                
                // load home page on first load SetContent
                if(loanType === undefined || loanType === "" || loanType === "all") {
                    showAllLoans();
                }
                else {
                    showFormsList(loanType);
                }
            });
        });
    })();

    function showSearchResults() {
        querry = getSearchQuerry().toLowerCase();

        var loanTypeResults = loanTypes.filter(x => x.name.toLowerCase().includes(querry));
        if(loanTypeResults != undefined && loanTypeResults.length != 0) {
            showFormsList(loanTypeResults[0].category)
        }
        
        var formResults = forms.filter(x => x.id.toLowerCase().includes(querry));
        if(formResults != undefined) {
            showSearchResultsForms(formResults);
        }

        setSearchQuerry("")
    }

    // Draws cards for all loan types
    function showAllLoans() {
        setloanType("all");
        var message = "Below are all the loans FSA offers. Forms differ depending on which loan type you select.  Please note:";
        
        $("#header-holder").empty();
        $("#header-holder").append(message);

        // Create a card for each loan category
        var cards = [];
        $.each(categories, function(key, type) {
            // Title of support page
            var titleText = `<div class="col loantype-title-name"> Farm Loan Application Form Support </div>`
            document.getElementById('title-holder').innerHTML = titleText;

            // Card for each loan type
            var new_card = `<div class="">
                                <div class="loantype-card-container">
                                    <div class="loantype-card-image-container">
                                        <img class="loantype-card-image" src="./images/loantypes/${type["image"]}" alt="${type["imageAltText"]}">
                                    </div>
                                    <div class="loantype-card-title">
                                        <h3> ${type["type"]} </h3>
                                    </div>
                                    <div class="loantype-card-description">
                                        <p> ${type["descriptionShort"]} </p>
                                    </div>
                                    <div class="loantype-card-button-container">
                                        <div class="loantype-card-button">
                                            <button class="btn lg-btn" onclick="showFormsList('${type["type"]}')" aria-label="View the ${type["type"]} forms" data-category="${type["type"]}" id="${type["type"]}">ACCESS FORMS</button>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
            cards.push(new_card);
        });

        $("#forms-holder").empty();
        $("#forms-holder").append(cards.join(""));

        // Remove back link
        $('#return-form-suport').empty();
    }

    // Draw Forms for loan Category type
    function showFormsList(category) {
        // Save seleted loan type cookie
        setloanType(category);
        var message = `Below are the forms used to apply for the ${category}. You may need to fill many of them to complete your application. Please select a form to start the walk tough process. You may comeplete the form as you go though this process. You may download the each form to your computers at any point to save your progress and resume working on it later. Please note:`;
        
        $("#header-holder").empty();
        $("#header-holder").append(message);

        // Get the the loan types for this category
        var categoryLoans = loanTypes.filter(function(item, i){ return item.category === category; });
        var categoryForms;
        $.each(categoryLoans, function(key, loan) { 
            var formsRequired = loan['formsRequired'].split(", ");
            if(formsRequired[0] == "") { formsRequired.pop(); }
            var formsRecommended = loan['formsRecommended'].split(", ");
            if(formsRecommended[0] == "") { formsRecommended.pop(); }
            var formsAdditional = loan['formsAdditional'].split(", ");
            if(formsAdditional[0] == "") { formsAdditional.pop(); }

            categoryForms = {
                formsRequired,
                formsRecommended,
                formsAdditional
            }
        });

        // Get the loan name
        var loanName = category;

        // Title of support page
        var titleText = `<div class="col">
                            <div class="loantype-title">    
                                <div class="quiz-back-container">
                                    <div class="quiz-back" id="quiz-back" style="">
                                        <a onclick="showAllLoans();return false;" aria-label="Go to Form Support Page">
                                            <img src="./images/angle-arrow-down.png" height="20" width="20" alt="Back to loans pages" style="margin-right:40px; transform: rotate(90deg);">
                                        </a>
                                    </div>
                                </div>
                                <div class="loantype-title-name">
                                    <div>${loanName} Form Support</div>
                                </div>
                            </div>
                        </div>`;
        document.getElementById('title-holder').innerHTML = titleText;
        
        // Description of support page
        var descriptioText = categories.find(x=> x.type === loanName).description;

        descriptioText = `<div class="col"> ${descriptioText} </div>`;
        $("header-holder").empty();
        document.getElementById("header-holder").innerHTML = descriptioText;

        // The cards for the individual forms
        var cards = [];
        var formIds = [];
        $("#forms-holder").empty();

        // Required
        if(categoryForms['formsRequired'].length != 0) {
            var categoryFormsContainer = document.createElement("div");
            categoryFormsContainer.classList.add("category-forms-container-reuired");

{           //Do first
            var title = document.createElement("div");}
            title.classList.add("category-forms-holder-title");
            title.textContent = "Do first";
            categoryFormsContainer.append(title);

            var message = document.createElement("div");
            message.classList.add("category-forms-holder-message");
            message.textContent = "Your loan application is not complete without these forms, make sure you fill these out first.";
            categoryFormsContainer.append(message);

            var categoryFormsHolder = document.createElement("div");
            categoryFormsHolder.classList.add("category-forms-holder");

            $.each(categoryForms['formsRequired'], function(key, formId) {
                var form = forms.find((x)=> x.id == formId)
                if(form !== undefined) {
                    categoryFormsHolder.append(_createCard(form, "REQUIRED"));
                    formIds.push(formId);
                }
            });
            categoryFormsContainer.append(categoryFormsHolder);
            $("#forms-holder").append(categoryFormsContainer);
        }

        // Recommended
        if(categoryForms['formsRecommended'].length != 0) {
            var categoryFormsContainer = document.createElement("div");
            categoryFormsContainer.classList.add("category-forms-container");

{                   //Do next
            var title = document.createElement("div");}
            title.classList.add("category-forms-holder-title");
            title.textContent = "Do next";
            categoryFormsContainer.append(title);

            var message = document.createElement("div");
            message.classList.add("category-forms-holder-message");
            message.textContent = "It's important to have a strong relationship with your Loan Officer as you start your journey with the FSA. The information you provide in these recommended forms equips your Loan Officer with the best information to help you through the process.";
            categoryFormsContainer.append(message);

            var categoryFormsHolder = document.createElement("div");
            categoryFormsHolder.classList.add("category-forms-holder");
            
            $.each(categoryForms['formsRecommended'], function(key, formId) {
                var form = forms.find(x=> x.id == formId)
                if(form !== undefined) {
                    categoryFormsHolder.append(_createCard(form, "RECOMENDED"));
                    formIds.push(form);
                }
            });
            categoryFormsContainer.append(categoryFormsHolder);
            $("#forms-holder").append(categoryFormsContainer);
        }

        // Additional
        if(categoryForms['formsAdditional'].length != 0) {
            var categoryFormsContainer = document.createElement("div");
            categoryFormsContainer.classList.add("category-forms-container");

{           //Do last
            var title = document.createElement("div");}
            title.classList.add("category-forms-holder-title");
            title.textContent = "Do last";
            categoryFormsContainer.append(title);

            var message = document.createElement("div");
            message.classList.add("category-forms-holder-message");
            message.textContent = "These documents are not required, but you must be able to discuss the topics below with your loan officer. Use these forms to help frame your conversation.";
            categoryFormsContainer.append(message);

            var categoryFormsHolder = document.createElement("div");
            categoryFormsHolder.classList.add("category-forms-holder");
            
            $.each(categoryForms['formsAdditional'], function(key, formId) {
                var form = forms.find(x=> x.id == formId)
                
                if(form !== undefined) {
                    categoryFormsHolder.append(_createCard(form, "ADDITIONAL"));
                    formIds.push(form);
                }
            });
            categoryFormsContainer.append(categoryFormsHolder);
            $("#forms-holder").append(categoryFormsContainer);
        }
        
        $('#return-form-suport').html(`<a href="" onclick="showAllLoans();return false;"  class="" data-label="" aria-label="Go to Form Support Page" data-category="Loans">See all loan types</a>`);
    }

    // Draw search results
    function showSearchResultsForms(results) {
        var message = `Below are the forms associated with your search.`;
        if(results.length == 0) {
            message = `No matches found.  Please try another search using either a form or name.`;
        }
        
        $("#header-holder").empty();
        $("#header-holder").append(message);
        $("#header-info-holder").empty();

        // Title of support page
        var titleText = `<div class="col">
                            <div class="loantype-title">    
                                <div class="loantype-title-back">
                                    <a href="" onclick="showAllLoans();return false;" data-label="/loanforms.html" aria-label="Go to Form Support Page" data-category="Loans">
                                        <img class="" src="./images/arrow-right.png" alt="Back arrow" width="32">
                                    </a>
                                </div>
                                <div class="loantype-title-name">
                                    <div> Search Results </div>
                                </div>
                            </div>
                        </div>`;
        document.getElementById('title-holder').innerHTML = titleText;

        // The cards for the individual forms
        var cards = [];
        var formIds = [];
        $("#forms-holder").empty();

        var categoryFormsContainer = document.createElement("div");
            categoryFormsContainer.classList.add("category-forms-container");
        
        var categoryFormsHolder = document.createElement("div");
            categoryFormsHolder.classList.add("category-forms-holder");

        $.each(results, function(key, form) {
            if(form !== undefined) {
                categoryFormsHolder.append(_createCard(form, "All"));
                formIds.push(form.id);
            }
        });
        categoryFormsContainer.append(categoryFormsHolder);
        $("#forms-holder").append(categoryFormsContainer);
        $('#return-form-suport').html(`<a href="" onclick="showAllLoans();return false;"  class="page-link" data-label="" aria-label="Go to Form Support Page" data-category="Loans">See all loan types</a>`);
    }

    // 
    function _createCard(form, required) {
        var new_card = document.createElement("div");
        new_card.classList.add("category-forms-card");

        var requirementType = document.createElement("div");
        switch(required) {
            case "REQUIRED":
                requirementType.classList.add("required"); // style in this file
                break;
            case "RECOMENDED":
                requirementType.classList.add("recomended"); // style in this file
                break;
            case "ADDITIONAL":
                requirementType.classList.add("additional"); // style in this file
                break;
            default:
            }

        
        requirementType.textContent = required
        
        var contentHolder = document.createElement("div");
        contentHolder.classList.add("category-forms-card-content");
        
        contentHolder.append(requirementType);

        var headline;
        headline = document.createElement("div");
        headline.classList.add("form-name");
        var h3;
        h3 = document.createElement("h3");
        h3.innerHTML = `<a href="" onclick="loadForm('${form.id}');return false;" "class="text-link" id="${form.id}">${form.name} </a>`
        headline.append(h3);

        contentHolder.append(headline);        

        var description = document.createElement("div");
        description.classList.add("content");

        var descriptionText = document.createElement("p");
        descriptionText.classList.add("form-description-text");
        descriptionText.textContent = form.description;
        description.append(descriptionText);

        contentHolder.append(description);

        var buttonContainer = document.createElement("div");
        buttonContainer.classList.add("button-container"); // style in this file

        var buttonAssistance = document.createElement("button");
        buttonAssistance.classList.add("button-holder"); // style in this file
        buttonAssistance.classList.add("button-blue"); // style in this file
        var t = document.createTextNode("FILL OUT FORMS");
        buttonAssistance.appendChild(t);   
        buttonAssistance.onclick = function(){loadForm(form.id)};
        buttonContainer.append(buttonAssistance);

        var buttonDownload = document.createElement("button");
        buttonDownload.classList.add("button-holder"); // style in this file
        buttonDownload.classList.add("button-white"); // style in this file
        var t = document.createTextNode("DOWNLOAD");
        buttonDownload.appendChild(t);
        buttonDownload.onclick = function(){downloadFile(`/forms/${form.file_name}`, form.file_name)};
        
        buttonContainer.append(buttonDownload);

        contentHolder.append(buttonContainer);
        new_card.append(contentHolder);
        return new_card;
    }

    // Load specific form
    function loadForm(formType) {
        setContent('form');
        setFormType(formType);
    }

    function downloadFile(url, fileName) {
        fetch(url, { method: 'get', mode: 'no-cors', referrerPolicy: 'no-referrer' })
        .then(res => res.blob())
        .then(res => {
        const aElement = document.createElement('a');
        aElement.setAttribute('download', fileName);
        const href = URL.createObjectURL(res);
        aElement.href = href;
        aElement.setAttribute('target', '_blank');
        aElement.click();
        URL.revokeObjectURL(href);
        });
    };

    // After DOM is loaded
    $(document).ready(function () {
        // Hide info if Eligibility Self-Assessment not complete
        if(userState() != 2) {
            document.getElementById('info-container-id').style.display = 'grid';  
        }
    });
</script>
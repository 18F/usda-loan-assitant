<link href="./css/quiz.css" rel="stylesheet" type="text/css" media="all"/>

<div class="fit-content">
    <div class="container" id="summary-container"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.4.0/jspdf.debug.js"></script>
<script type="text/javascript" src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.js"></script>


<script src="../js/stateManager.js"></script>
<script>
    var questions = []; // LIst of questions
    var questionHistory = []; // List of answered questions
    var questionHistoryIndex = -1;
    var questionType = ""
    var currentQuestion = -1;
    var nextQuestionId = -1;
    var answers = [];
    var conditionals = [];
    var progressBarStage = "You and your farm";
    var pdfData = [];
    var hasYouthLoan = false;
    var primaryRecomendation = "";
    var categoryCount = 0; //used to count number of categories in report

    // Printed/saved report
    var bestMatch;
    var bestMatchDescription;
    var bestMatchNote;
    var loanInfoCategory;
    var categories;
    var loanTypes;
    
    var report = document.createElement("div");
    report.classList.add("result-container");
    report.setAttribute("id","report");
    $('#main-content').append(report);
    $(report).hide();

    (function() {
        currentQuestion = 0;
        if(geAnswers() !== ""){
            questionHistory = JSON.parse(geAnswers());
            // Set the current question based on last unanswered question
            if(isNaN(questionHistory[0]['nextQuestionId'])) {
                currentQuestion = 0;
            }
            else{
                currentQuestion = Math.max.apply(null, questionHistory.map(object => { return object.nextQuestionId; }));
            }
        }

        $.getJSON("/forms/loantypes.json", function(data) {
            categories = [...data['categories']];
            loanTypes = [...data['loanType']];

            // Get list of questions
            $.getJSON("../quiz.json", function(data) {
                questions = data["questions"];
                
                // Clean up assigned values
                for ( var i = 0; i < questions.length; i++ ) {
                    // remove options
                    var arr = questions[i].options.filter(function(x) {
                        return x.optionId !== -1;
                    });
                    questions[i].options = arr;
                    // remove option paragraphs
                    for ( var j = 0; j < questions[i].options.length; j++ ) {
                        arr = questions[i].options[j].paragraphs.filter(function(x) {
                            return x.paragraphText !== "";
                        });
                        questions[i].options[j].paragraphs = arr;
                    }
                    // remove content paragraphs
                    arr = questions[i].content.paragraphs.filter(function(x) {
                        return x.paragraphText !== "";
                    });
                    questions[i].content.paragraphs = arr;
                }

                // Decide what to show
                // Open a URL or show quiz
                if(isNaN(currentQuestion)) {
                    window.open(nextQuestionId);
                    return;
                }
                else {
                    showQuestion(currentQuestion);
                }
            });
        });
    })();

    //////////////////
    // Quiz Logic
    //////////////////
    // Shows question
    function showQuestion(questionId) {
        categoryCount = 0;
        // check the summary page should be loaded
        if(nextQuestionId === 9999 || currentQuestion === 9999) {
            progressBarStage = "Results";
            nextQuestionId = questionHistory[questionHistory.length - 1].guestion;
            _createSummary();
        }
        else {
            $.each(questions, function(key, questionData) {
                if(questionData.questionId === questionId){
                    progressBarStage = questionData['progressBarStage'];
                    _createQuestionContainer();
                    currentQuestion = questionId;
                    answers = [];

                    var index = questionHistory.findIndex(x => x.question === currentQuestion);
                    questionHistoryIndex = index;
                    if(index === -1)
                    {
                        nextQuestionId = -1;
                        questionHistoryIndex = questionHistory.length;
                        questionHistory[questionHistoryIndex] = answer();
                    }
                    else {
                        answers = questionHistory[index]['answer'];
                        nextQuestionId = questionHistory[index]['nextQuestionId'];
                    }

                    questionType = questionData["type"];
                    switch (questionType) {
                        case 'information':
                            _createInformationCard(questionData);
                            break;
                        case 'multiselect':
                            _createMultiselctQuestion(questionData);
                            break;
                        case 'singlesselect':
                            _createSingleSelectQuestion(questionData);
                            break;
                        case 'yesno':
                            _createYesNoQuestion(questionData);
                            break;
                        case 'singleselectcards':
                            _createSingleSelectCardQuestion(questionData);
                            break;
                        default:
                            console.log(`not a valid type`);
                    };
                    _createBackStepLink();
                }
            });
        }
    }
    
    //////////////////
    // Summary Page
    //////////////////
    function _createProgressbar() {
        // create container for all progress bar elements
        var progressBar = document.createElement("div");
        progressBar.classList.add("quiz-progress-bar-container");
        progressBar.setAttribute("id","progressbar"); 

        // create back button
        var backArrowContainer = document.createElement("div");
        backArrowContainer.classList.add("quiz-back-container");
        var backArrow = document.createElement("div");
        backArrow.classList.add("quiz-back");
        backArrow.id = "quiz-back";
        backArrowContainer.append(backArrow);
        progressBar.append(backArrowContainer);
        
        var map = document.createElement("div");
        map.classList.add("quiz-progress-bar-map-container");
        progressBar.append(map);
        
        // create the bar
        var bar = document.createElement("div");
        bar.classList.add("quiz-progress-bar-map-bar-back");
        map.append(bar);

        var bar = document.createElement("div");
        bar.classList.add("quiz-progress-bar-map-bar");
        map.append(bar);
        
        // add the markers on the bar
        var markers = document.createElement("div");
        markers.classList.add("quiz-progress-bar-map-bar-markers");
        
        var marker = document.createElement("div");
        marker.classList.add("quiz-progress-bar-map-bar-marker");
        marker.append(_createStepBullet(1, "fill-green"));
        markers.append(marker);

        marker = document.createElement("div");
        marker.classList.add("quiz-progress-bar-map-bar-marker");
        var fill = "border-grey"

        if(progressBarStage == "Loan Eligibility" || progressBarStage == "Results") {
            fill = "fill-green"
            bar.style.width = '68%';
        }
        marker.append(_createStepBullet(2, fill));
        markers.append(marker);
        
        marker = document.createElement("div");
        marker.classList.add("quiz-progress-bar-map-bar-marker");
        fill = "border-grey"
        if(progressBarStage == "Results") {
            fill = "fill-green"
            bar.style.width = '68%';
        }
        marker.append(_createStepBullet(3, fill));
        markers.append(marker);

        map.append(markers);
        progressBar.append(map);

        // add the labels under the bar
        var progressLabels = document.createElement("div");
        progressLabels.classList.add("quiz-progress-bar-labels-container");
        var active = "quiz-progress-bar-label-active";

        var progressLabel = document.createElement("div");
        progressLabel.classList.add("quiz-progress-bar-label", active);
        progressLabel.textContent= "You and your farm";
        progressLabels.append(progressLabel);

        progressLabel = document.createElement("div");
        progressLabel.classList.add("quiz-progress-bar-label");
        progressLabel.textContent = "Loan eligibility";
        progressLabels.append(progressLabel);
        if(progressBarStage == "Loan Eligibility" || progressBarStage == "Results") {
            progressLabel.classList.add("quiz-progress-bar-label", active);
        }

        progressLabel = document.createElement("div");
        progressLabel.classList.add("quiz-progress-bar-label");
        progressLabel.textContent= "Results"
        progressLabels.append(progressLabel);
        if(progressBarStage == "Results") {
            progressLabel.classList.add("quiz-progress-bar-label", active);
        }

        progressBar.append(progressLabels);

        // create retake quiz button
        var retakeQuizLink = document.createElement("div");
        retakeQuizLink.classList.add("quiz-retake-container");

        var a = document.createElement('a');
        var linkText = document.createTextNode("Retake quiz");
        a.appendChild(linkText);
        a.title = "Retake quiz";
        $(a).off().on('click', retakeQuiz.bind(this));
        $(a).on('click',function() {
            retakeQuiz.bind(this);
            $(this).off('click');
        });
        retakeQuizLink.append(a);
        progressBar.append(retakeQuizLink);

        $('#progressbar').empty();
        return progressBar;
    }

    function retakeQuiz() {
        setCookie("answers", '', -1);
        setContent("quiz");
    }
        
    function _createQuestionContainer() {
        var container = document.createElement("div");
        container.classList.add("quiz-container");

        container.append(_createProgressbar());

        var question = document.createElement("div");
        question.classList.add("quiz-questions-container");
        question.id = "quiz-questions-container";
        container.append(question);

        $('#summary-container').empty();
        $('#summary-container').append(container);
    }

    function _createSummary() {
        var summary = document.createElement("div");
        summary.classList.add("quiz-summary");
        
        summary.append(_createProgressbar());

        // Title
        var text = "FSA Farm Loan Quiz Results";
        var titleDiv = document.createElement("h1");
        titleDiv.classList.add("quiz-summary-title");
        titleDiv.textContent = text;
        summary.append(titleDiv);
        
        //Description
        text = "Based on your answers to the Farm Loan Quiz, we have matched you with a farm loan that will best fit your financing needs. Review the loan details and start your application process by completing the steps outline below.";
        var descriptionDiv = document.createElement("h1");
        descriptionDiv.classList.add("quiz-summary-paragraph");
        descriptionDiv.textContent = text;
        summary.append(descriptionDiv);

        // recomended loan
        summary.append(_createRecomendedLoans());
        
        // Flags
        if(primaryRecomendation != "Youth Loan") {
            text = "Below are the things we’ve flagged and recommend talking to your loan officer about.";
            var flagDescriptionDiv = document.createElement("h1");
            flagDescriptionDiv.classList.add("quiz-summary-paragraph-highlight");
            flagDescriptionDiv.textContent = text;
            summary.append(flagDescriptionDiv);

            summary.append(_createFlagMessages());
        }
        
        // Steps
        summary.append(_createSummarySteps());


        $('#summary-container').empty();
        $('#summary-container').append(summary);
        _createBackStepLink();
    }

    function _createRecomendedLoans() {
        // Has a main loan and posible additioonal recomendations
        var loans = document.createElement("div");
        
        // primary recomendation
        var loan = document.createElement("div");
        loans.append(loan);

        // recomended loan cards
        var recomended = document.createElement("div");
        recomended.classList.add("recomended-loans-container");
        loans.append(recomended);
        
        // Find the multiselect question
        var multiSelectQuestionId;
        for ( var i = 0; i < questions.length; i++ ) {
            if(questions[i].conditionals.includes("&")) {
                multiSelectQuestionId = questions[i].questionId;
            }
        }

        var multiselctAnswers = questionHistory.find(x=> x.question == multiSelectQuestionId).answer;
        multiselctAnswers.sort(function(a, b) {return b - a;} );
        
        for ( var i = 0; i < multiselctAnswers.length; i++ ) {
            var loanInfo = loanTypes.find(x => x.loanId == multiselctAnswers[i]);
            var category = categories.find(x => x.type.includes(loanInfo.category));

            var loansInCategory = [];
            loansInCategory = loanTypes.filter(x => x.category == category.type);

            switch(category.type) {
                case "Farm Operating Loan":
                    var operatingMicroloanList = questions.filter(x=> x.conditionals.includes("Operating Microloan"))
                    for ( var j = 0; j < operatingMicroloanList.length; j++ ) {
                        var answer = questionHistory.find(x=> x.question == operatingMicroloanList[j].questionId);
                        if(answer != undefined) {
                            if(answer.answer[0] == 1) {
                                loanInfo = loanTypes.find(x => x.name == "Operating Microloan");
                                category = categories.find(x => x.type == loanInfo.category);
                                loansInCategory = [];
                                loansInCategory.push(loanInfo);
                            }
                        }
                    }
                    break;
                case "Farm Ownership Loan":
                    var microloanFarmOwnershipList = questions.filter(x=> x.conditionals.includes("Microloan Farm Ownership"))
                    for ( var j = 0; j < microloanFarmOwnershipList.length; j++ ) {
                        var answer = questionHistory.find(x=> x.question == microloanFarmOwnershipList[j].questionId);
                        if(answer != undefined) {
                            if(answer.answer[0] == 1) {
                                loanInfo = loanTypes.find(x => x.name.includes("Microloan Farm Ownership"));
                                category = categories.find(x => x.type == loanInfo.category);
                                loansInCategory = [];
                                loansInCategory.push(loanInfo);
                            }
                        }
                    }
                    break;
                case "Youth Loan":
                    hasYouthLoan = true;
                    break;
                default:
            }

            if(primaryRecomendation == "") {
                primaryRecomendation = category.type;
            }

            recomended.append(_createSugestedLoanCards(category, loansInCategory, loanInfo, i, loan, recomended));
        }
        return loans;
    }

    // shows a detailed view of the primary loan, and if available minimal details for other loan types
    // loanInfo = details from JSON, index = index from array of sugested loans
    function _createSugestedLoanCards(category, loansInCategory, loanInfo, index, loan, recomended) {
        if(hasYouthLoan && category.type != "Youth Loan") {
            return "";
        }

        // Image
        if(categoryCount == 0) {
            var imageContainer = document.createElement("img");
            imageContainer.classList.add("recomended-imageContainer");

            var image = document.createElement("img");
            image.classList.add("recomended-image");
            image.src = './images/loantypes/'+loanInfo.image;
            loan.append(image);
        }
        categoryCount++;

        // Title
        var loanInfoCategoryTitle = loanInfo.category;

        if(loanInfoCategoryTitle == "Microloan") {
            loanInfoCategoryTitle = loansInCategory[0].name;
        }
        
        var titleDiv = document.createElement("h1");
        titleDiv.classList.add("quiz-summary-subtitle");
        titleDiv.textContent = loanInfoCategoryTitle;
        loan.append(titleDiv);

        // Description
        var text =  +  + ".";
        
        var descriptionDiv = document.createElement("span");
        descriptionDiv.classList.add("quiz-summary-paragraph");
        descriptionDiv.textContent = "Based on your responses we think you’re best suited for the ";
        
        var descriptionHighlight = document.createElement("span");
        descriptionHighlight.classList.add("quiz-summary-paragraph-highlight");
        descriptionHighlight.textContent = "FSA "+loanInfoCategoryTitle;
        descriptionDiv.append(descriptionHighlight);
        
        var descriptionPeriod = document.createElement("span");
        descriptionPeriod.classList.add("quiz-summary-paragraph");
        descriptionPeriod.textContent = ".";
        descriptionDiv.append(descriptionPeriod);

        loan.append(descriptionDiv);

        var descriptionDiv = document.createElement("h1");
        descriptionDiv.classList.add("quiz-summary-paragraph");
        if(category.description.includes("|")) {
            var paragraphs = category.description.split("|");
            paragraphs = paragraphs.filter(n => n);
            for( var i = 0; i < paragraphs.length; i++ ) {
                var paragraph = paragraphs[i].replace("|","");
                var paragraphDiv = document.createElement("p");
                paragraphDiv.textContent = paragraph;
                descriptionDiv.append(paragraphDiv);
            }
        }
        loan.append(descriptionDiv);

        var noteDiv = document.createElement("h1");
        noteDiv.classList.add("quiz-summary-note");
        noteDiv.textContent = category.note;
        loan.append(noteDiv);

        loanInfoCategory = loansInCategory[0].category;
        bestMatch = text;
        bestMatchDescription = category.description;
        bestMatchNote = category.note;

        var loanCardHolder = document.createElement("div");
        loanCardHolder.classList.add("recomended-loan-card-holder");
        for ( var i = 0; i < loansInCategory.length; i++ ) {
            var loanCard = document.createElement("div");
            loanCard.classList.add("recomended-loans-card");
            // Name
            var title = document.createElement("div");
            title.classList.add("recomended-loans-card-title");
            title.textContent = loansInCategory[i].name;
            loanCard.append(title);

            // List of details
            var list = document.createElement("ul");
            // Max dollar ammount description
            if(loansInCategory[i].maximumDollarAmountDescription != ""){
                let item = document.createElement("li");
                item.innerHTML = loansInCategory[i].maximumDollarAmountDescription;
                list.appendChild(item);
            }

            // down payment description
            if(loansInCategory[i].downPaymentDescription != ""){
                item = document.createElement("li");
                item.innerHTML = loansInCategory[i].downPaymentDescription;
                list.appendChild(item);
            }

            // Loan term description
            if(loansInCategory[i].loanTermDescription != ""){
                item = document.createElement("li");
                item.innerHTML = loansInCategory[i].loanTermDescription;
                list.appendChild(item);
            }

            // Interest Rate description
            if(loansInCategory[i].interestRateDescription != ""){
                var interestRateValue = loansInCategory[i].interestRateDescription;
                if(loansInCategory[i].interestRateURL != "") {
                    var urlText = "View current rates"
                    interestRateValue = interestRateValue.replace(urlText, "")
                    var link = document.createElement("a");
                    link.classList.add("quiz-view-rates");
                    var linkText = document.createTextNode(urlText);
                    link.appendChild(linkText);
                    link.title = urlText;
                    $(link).off().on('click', openURL.bind(this, loansInCategory[i].interestRateURL));
                    $(link).on('click',function() {
                        openURL.bind(this, loansInCategory[i].interestRateURL);
                        $(this).off('click');
                    });  

                    linkDiv = document.createElement("div");
                    

                    linkDiv.textContent = interestRateValue;
                    linkDiv.appendChild(link);

                    interestRateValue = linkDiv;
                }

                item = document.createElement("li");
                item.appendChild(interestRateValue);

                list.appendChild(item);
            }

            // other requirements description
            if(loansInCategory[i].otherRequirements !== "N/A" && loansInCategory[i].otherRequirements !== "") {
                item = document.createElement("li");
                item.innerHTML = loansInCategory[i].otherRequirements;
                list.appendChild(item);
            }
            loanCard.append(list);
            loanCardHolder.append(loanCard);
        }
        loan.append(loanCardHolder);
        return loan;
    }

    // Shows all flags in a list
    function _createFlagMessages() {
        var flagContainer = document.createElement("div");
        
        questions.sort((a, b) => a.notificationType.localeCompare(b.notificationType));

        var flagsList = questionHistory.filter(x=> x.answer[0] == 0);
        for (var i = 0; i < flagsList.length; i++) {
            var flagMessage = questions.find(x=> x.questionId == flagsList[i].question);
            flagContainer.append(_createFlag(flagMessage));
        }
        return flagContainer;
    }

    // The actual flag used in flag list and full report
    function _createFlag(flagMessage) {
        var flag = document.createElement("div");

        flag.classList.add("quiz-summary-flag");
        if(flagMessage.notificationType == "alert") {
            flag.classList.add("quiz-summary-flag-alert-background");
        }
        else {
            flag.classList.add("quiz-summary-flag-warning-background");
        }
        
        var div = document.createElement("div");
        div.classList.add("quiz-summary-flag-leftbar");
        if(flagMessage.notificationType == "alert") {
            div.classList.add("quiz-summary-flag-leftbar-alert-background");
        }
        else {
            div.classList.add("quiz-summary-flag-leftbar-warning-background");
        }
        flag.append(div);

        div = document.createElement("div");
        div.classList.add("quiz-summary-flag-iconholder");
        var image = document.createElement("img");
        if(flagMessage.notificationType == "alert"){
            image.src = './images/alerts/error.png';
        }
        else {
            image.src = './images/alerts/warning.png';
        }
        div.append(image);
        flag.append(div);

        var textHolder = document.createElement("div");
        textHolder.classList.add("quiz-summary-flag-text");

        div = document.createElement("div");
        div.classList.add("quiz-summary-flag-text-title");
        div.classList.add("quiz-summary-subtitle");
        div.append(_createTitle(flagMessage.notificationTitle));
        textHolder.append(div);

        div = document.createElement("div");
        div.classList.add("quiz-summary-flag-text-message");
        div.classList.add("quiz-summary-paragraph");
        div.textContent = flagMessage.notificationMessge;
        textHolder.append(div);

        flag.append(textHolder);

        return flag;
    }

    // The steps to apply for a loan
    function _createSummarySteps() {
        var stepinfo = [];
        stepinfo.push({
            "text": "Complete the readiness checklist",
            "message": "In addition to the quiz, you will need to bring a few other things to your meeting with your local loan officer.",
            "buttons": [ {
                    "buttonText": "DOWNLOAD READINESS CHECKLIST",
                    "buttonURL": "checklist",
                }
            ],
            "hasFulleReport": false,
        });
       
        stepinfo.push({
            "text": "Get help filling out the forms",
            "message": "Complete and print each form pertaining to your matched loan to add to your application package. We provide step-by-step instructions on completing each loan application form.",
            "buttons": [ {
                    "buttonText": "ACCESS FORMS",
                    "buttonURL": "onclick=showRelatedForms",
                }
            ],
            "hasFulleReport": false,
        });
       
        stepinfo.push({
            "text": "Find your local farm loan office",
            "message": "Find your local FSA Service Center and contact the Farm Loan Manager or the service center office.",
            "buttons": [ {
                    "buttonText": "FIND LOCAL FARM LOAN CENTER",
                    "buttonURL": "https://offices.sc.egov.usda.gov/locator/app?state=us&agency=fsa",
                }
            ],
            "hasFulleReport": false,
        });
        
        if(!hasYouthLoan) {
            stepinfo.push({
                "text": "Download your quiz responses",
                "message": "We recommend downloading and/or printing the quiz and discussing your answers with your local loan officer.",
                "buttons": [ {
                        "buttonText": "DOWNLOAD QUIZ",
                        "buttonURL": "onclick=savePDF",
                    },
                    {
                        "buttonText": "PRINT QUIZ",
                        "buttonURL": "onclick=printPDF",
                    }
                ],
                "hasFulleReport": true,
            });
        }

        var steps = document.createElement("div");
        steps.classList.add("summary-step-container");
        
        for (var i = 0; i < stepinfo.length; i++) {
            var step = document.createElement("div");
            step.classList.add("summary-step");
            
            var div = document.createElement("div");
            div.classList.add("summary-step-iconholder");
            div.append(_createStepBullet(i+1, 'fill-green'));
            step.append(div);

            var textHolder = document.createElement("div");
            textHolder.classList.add("summary-step-text");

            div = document.createElement("h3");
            div.classList.add("summary-step-text-title");
            div.classList.add("quiz-summary-subtitle");
            div.textContent = stepinfo[i].text;
            textHolder.append(div);

            div = document.createElement("div");
            div.classList.add("summary-step-text-message");
            div.classList.add("quiz-summary-paragraph");
            div.textContent = stepinfo[i].message
            textHolder.append(div);
            
            var buttonContainer = document.createElement("div");
            buttonContainer.classList.add("summary-step-text-button-container");
            for (var j = 0; j < stepinfo[i].buttons.length; j++) {

                if(stepinfo[i].buttons[j].buttonURL.includes("onclick")){
                    var button = document.createElement('button');
                    button.classList.add("summary-step-text-button");
                    if(j==1) {
                        button.classList.add("summary-step-text-button-second");
                    }
                    var text = document.createTextNode(stepinfo[i].buttons[j].buttonText);
                    button.appendChild(text);

                    var func_name = stepinfo[i].buttons[j].buttonURL.split('=')[1];
                    $(button).off().on('click', eval(func_name).bind(this));
                    $(button).on('click',function() {
                        eval(func_name).bind(this);
                        //$(this).off('click');
                    });
                }
                if(stepinfo[i].buttons[j].buttonURL.includes("checklist")) {
                    var button = document.createElement('button');
                    button.classList.add("summary-step-text-button");
                    var text = document.createTextNode(stepinfo[i].buttons[j].buttonText);
                    button.appendChild(text);

                    var url = categories.find(x=> x.type == primaryRecomendation).checklist.toString();
                    $(button).off().on('click', openURL.bind(this, url));
                    $(button).on('click',function() {
                        openURL.bind(this, url);
                        //$(this).off('click');
                    });     
                }
                if(stepinfo[i].buttons[j].buttonURL.includes("http")) {
                    var button = document.createElement('button');
                    button.classList.add("summary-step-text-button");
                    var text = document.createTextNode(stepinfo[i].buttons[j].buttonText);
                    button.appendChild(text);

                    $(button).off().on('click', openURL.bind(this, stepinfo[i].buttons[j].buttonURL));
                    $(button).on('click',function() {
                        openURL.bind(this, stepinfo[i].buttons[j].buttonURL);
                        $(this).off('click');
                    });                    
                }

                buttonContainer.append(button);
                textHolder.append(buttonContainer);
            }
                
            step.append(textHolder);
            
            if(stepinfo[i].hasFulleReport){
                step.append(_createFullReport());
            }
        
            steps.append(step);
        }
        return steps;
    }

    // The list of questions and answers shown in _createSummarySteps step 4
    function _createFullReport() {
        /////////////////
        //  Full Report
        var fullReport = document.createElement("div");
        fullReport.classList.add("full-report-container");
        fullReport.id = "fullReport"
        
        text = "Full printable quiz";
        fullReport.append(_createTitle(text));

        text = "Print this out and bring it to your appointment with your loan officer to help guide your conversation.";
        fullReport.append(_createParagraphElement(text));

        var fullReportResultsContainer = document.createElement("div");
        fullReportResultsContainer.classList.add("result-acccordion-closed");
        fullReportResultsContainer.id = "accordion"
        // Results
        for( var i = 0; i < questionHistory.length; i++ ) {
            // Create a result container
            var result = document.createElement("div");
            result.classList.add("full-report-result-container");
            
            // Add a bullet
            var bullet = document.createElement("div");
            bullet.classList.add("full-report-result-bullet-container");
            bullet.append(_createStepBullet(i+1, 'border-green'));
            result.append(bullet);

            // Add the info to hold all of the details
            var info = document.createElement("div");
            info.classList.add("full-report-result-info");
            result.append(info);

            // Add Question Text
            var answerInfo = questions.find(x => x.questionId == questionHistory[i].question)
            var questionText = answerInfo['content'].title;
            var infoTitle = document.createElement("div");
            infoTitle.classList.add("full-report-result-info-title");
            infoTitle.append(_createTitle(questionText));
            info.append(infoTitle);

            //  Add Answer
            var answerText;
            var answerTexts = [...questionHistory[i].answer];
            var answer = [];
            for ( var j = 0; j < answerTexts.length; j++ ) {
                answer.push(answerInfo.options.find(x => x.value == answerTexts[j]).title);
                var infoMessage = document.createElement("div");
                infoMessage.classList.add("full-report-result-info-message");
                infoMessage.append(_createParagraphElement(answer));
                info.append(infoMessage);
                
                var flagMessage = questions.find(x=> x.questionId == questionHistory[i].question);

                if(questionHistory[i].answer == 0) {
                    var flag = document.createElement("div");
                    flag.classList.add("full-report-result-info-flag");
                    flag.append(_createFlag(flagMessage)); 
                    info.append(flag);
                }
            }

            var qaPair = {
                "question": questionText,
                "answer": answer,
            }
            pdfData.push(qaPair);
            fullReportResultsContainer.append(result);
            
        }
        fullReport.append(fullReportResultsContainer); 
        
        var toggle = document.createElement("div");
        toggle.classList.add("result-accordion-toggle");
        toggle.textContent = "SHOW MORE +"
        $(toggle).off().on('click', toggleAccordion.bind(this, toggle));
        $(toggle).on('click',function() {
            toggleAccordion.bind(this);
        });

        fullReport.append(toggle); 

        _createSaveableReport();
        return fullReport;
    }
    
    function toggleAccordion(toggle) {
        let accordion = document.getElementById('accordion')
        if (accordion.className === 'result-acccordion-closed') {
            accordion.className = 'result-acccordion-open';
            toggle.textContent = "SHOW LESS -";
        } 
        else {
            accordion.className = 'result-acccordion-closed';
            toggle.textContent = "SHOW MORE +";
            document.getElementById("fullReport").scrollIntoView();
        }
	}

    function _createSaveableReport() {
        var imageContainer = document.createElement("div");
        imageContainer.classList.add("result-image-container");
        
        var image = document.createElement("img");
        image.classList.add("result-image");
        image.setAttribute("src", "./images/usda_banner.png");
        imageContainer.append(image);
        report.append(imageContainer);

        var title = document.createElement("div");
        title.classList.add("result-title");
        title.textContent = "Loan quiz summary page";
        report.append(title);

        var subTitle = document.createElement("div");
        subTitle.classList.add("result-subTitle");
        subTitle.textContent = "Loan Assistance Tool, USDA Federal Service Agency";
        report.append(subTitle);

        var recommendation = document.createElement("div");
        recommendation.classList.add("result-recommendation");
        recommendation.textContent = "Loan recommendation";
        report.append(recommendation);

        var bestMatchText = document.createElement("div");
        bestMatchText.classList.add("result-recommendation-description");
        var text = "Based on your responses we think you’re best suited for the FSA " + primaryRecomendation + ".";
        bestMatchText.textContent = text;
        //multiselctAnswers
        report.append(bestMatchText);

        text = categories.find(x=> x.type == primaryRecomendation).description

        var bestMatchDescriptionText = document.createElement("div");
        bestMatchDescriptionText.classList.add("result-recommendation-description");
        bestMatchDescriptionText.textContent = text;
        report.append(bestMatchDescriptionText);

        text = categories.find(x=> x.type == primaryRecomendation).note

        var bestMatchNoteText = document.createElement("div");
        bestMatchNoteText.classList.add("result-recommendation-note");
        bestMatchNoteText.textContent = text;
        report.append(bestMatchNoteText);
       
        var fullQuizText = document.createElement("div");
        fullQuizText.classList.add("result-recommendation-fullQuizText");
        fullQuizText.textContent = "Full quiz";
        report.append(fullQuizText);

        var fullQuizSubText = document.createElement("div");
        fullQuizSubText.classList.add("result-recommendation-fullQuizSubText");
        fullQuizSubText.textContent = "Below are all of the questions and answers to the quiz. We recommend you review these with your loan officer. ";
        report.append(fullQuizSubText);


        var resultContainer = document.createElement("div");
        resultContainer.classList.add("result-tile-container");

        for ( var i = 0; i < pdfData.length; i++ ) {
            var resultTile = document.createElement("div");
            resultTile.classList.add("result-tile");

            var resultNumber = document.createElement("div");
            resultNumber.classList.add("result-number");
            resultNumber.textContent = i + 1 +".";
            resultTile.append(resultNumber);

            var resultQuestion = document.createElement("div");
            resultQuestion.classList.add("result-question");
            resultQuestion.textContent = pdfData[i].question;
            resultTile.append(resultQuestion);
            
            var resultAnswer = document.createElement("div");
                resultAnswer.classList.add("result-answer");
            for ( var j = 0; j < pdfData[i].answer.length; j++ ) {
                var resultAnswerText = document.createElement("div");
                resultAnswerText.textContent = pdfData[i].answer[j];
                resultAnswer.append(resultAnswerText);
            }
            resultTile.append(resultAnswer);
            resultContainer.append(resultTile);
        }
        report.append(resultContainer);
    }

    // The circle with a number to th eleft of steps and questions
    function _createStepBullet(number, type) {
        var bullet = document.createElement("div");
        bullet.classList.add("step-bullet");
        switch (type) {
            case 'fill-green':
                bullet.classList.add("step-bullet-green-fill");
                break; 
            case 'border-green':
                bullet.classList.add("step-bullet-green-border");
                break;
            case 'border-grey':
                bullet.classList.add("step-bullet-grey-border");
                break; 
        }
        bullet.textContent = number;
        return bullet;
    }
    
    ///////////////////////////////////////
    // Save, Next and Back functions
    ///////////////////////////////////////
    // Saves answer and shows next question
    function saveAndNext() {
        // Get list of answers from the multi select answers
        if(questionType == "multiselect") {
            if(answers.findIndex(x => x.value !== -1) > -1) {
                var multiAnswers = [];
                for ( var i = 0; i < answers.length; i++ ) { 
                    multiAnswers.push(answers[i]['value']);
                }
                answers = [...multiAnswers];
            }
        }

        // add answer to array
        var index  = questionHistory.findIndex(x => x.question === currentQuestion);

        questionHistory[index] = answer();

        updateAnswers();
        showQuestion(nextQuestionId);
        nextQuestionId = -1;
    }
    
    // Creates a link to the next question.  If next step is based on user choice the link wil be inactive until choice is made
    function _createNextStepLink() {
        var parent = document.createElement('div');
        parent.classList.add("quiz-next-container");
        
        // Add inactive link
        var div = document.createElement('div');
        div.classList.add("quiz-next-inactive");
        div.id = 'quiz-next-inactive';
        var nextLink = document.createElement('a');
        nextLink.innerHTML = "Save and continue"
        nextLink.onclick = function() { null };
        div.appendChild(nextLink);
        parent.appendChild(div);
        
        // Add active link
        div = document.createElement('div');
        div.classList.add("quiz-next");
        div.id = 'quiz-next-active';

        nextLink = document.createElement('a');
        nextLink.innerHTML = "Save and continue"
        nextLink.onclick = function() { saveAndNext(); };
        div.appendChild(nextLink);
        parent.appendChild(div);
        return parent;
    }

    function setNextLinkValues() {
        $('#quiz-next-inactive').hide();
        $('#quiz-next-active').hide();

        if(nextQuestionId >= 0 || isNaN(nextQuestionId)) {
            $('#quiz-next-active').show();
        }
        else {
            $('#quiz-next-inactive').show();
        }
    }

    function _createBackStepLink() {
        $('#quiz-back').hide();

        if(questionHistory.length === 0) { return; }
        if(questionHistory[0]['question'] !== currentQuestion) {
            $('#quiz-back').show();
            var image = document.createElement("img");
            image.setAttribute("src", "./images/angle-arrow-down.png");
            image.setAttribute("height", "32");
            image.setAttribute("width", "32");
            image.setAttribute("alt", "Back to previous step");
            image.style.transform = "rotate(90deg)";

            var previoousLink = document.createElement('a');

            previoousLink.onclick = function() { 
                var id = questionHistory.findIndex(x => x.question === currentQuestion) -1;
                if(id === -2) {
                    id = questionHistory.length-1;
                    currentQuestion = questionHistory[id].question;
                    nextQuestionId = questionHistory[id].question;
                }

                showQuestion(questionHistory.at(id)['question']);
                
                if(id === 0) {
                    $('#quiz-back').hide();
                }
                if(nextQuestionId === -1) {
                    questionHistory.pop();
                }
            }
            previoousLink.appendChild(image);
            $('#quiz-back').empty();
            $('#quiz-back').append(previoousLink);
        }
    }

    ///////////////////
    // Information Card
    ///////////////////
    // Creates an information question card: Text and a continue button
    function _createInformationCard(questionData) {
        nextQuestionId = questionData['options'][0]['nextQuestionId'];
        var question = document.createElement("div");
        question.classList.add("quiz-question");
        question.append(_createTitle(questionData['content']['title']));
        question.append(_createParagraphs(questionData['content']['paragraphs']));
        question.append(_createInformationButtons(questionData['options']));
        $('#quiz-questions-container').empty();
        $('#quiz-questions-container').append(question);
    }
    
    function _createInformationButtons(options) {
        var buttonDiv = document.createElement("div");
        for ( var i = 0; i < options.length; i++ ) {
            if(options[i]['title'] !== "") { 
                var button = document.createElement("button");
                button.type = "button";
                //button.classList.add("btn");
                //button.classList.add("btn-default");
                button.textContent = options[i]['title'];
                $(button).off().on('click', setInformationLinks.bind(this, options[i], button));
                $(button).on('click',function() {
                    setInformationLinks.bind(this, options[i], button);
                    $(this).off('click');
                });
                buttonDiv.append(button);
            }
        }
        return buttonDiv;
    }

    function setInformationLinks(option) {
        nextQuestionId = option.nextQuestionId;
        answers.push(option.value);
        saveAndNext();
    }

    ///////////////////////////
    // Multi-selection Question
    ///////////////////////////
    // Creates a MultiSelect question card: a grid of cards with checkboxes.  One or more must be selected to continue
    function _createMultiselctQuestion(questionData) {
        var question = document.createElement("div");
        question.classList.add("quiz-question");
        question.append(_createTitle(questionData['content']['title']));
        question.append(_createParagraphs(questionData['content']['paragraphs']));
        question.append(_createMultiSelectItems(questionData['options']));
        question.append(_createNextStepLink());
        $('#quiz-questions-container').empty();
        $('#quiz-questions-container').append(question);
   
        // Conditionals structure "1&2:12,1&3:1,2&3:2"
        // value&value:questionId
        var tmpConditionals = questionData['conditionals'].split(",");
        for ( var i = 0; i < tmpConditionals.length; i++ ) {
            var tmpCondition = tmpConditionals[i].split(":");
            var values = tmpCondition[0].split("&");
            var condition = {
                "value1": values[0],
                "value2": values[1],
                "nextQuestionId": tmpCondition[1]
            }
            conditionals.push(condition)
        }

        let data = questionHistory.find(x => x.question === currentQuestion);
        var checkboxesAll = [];
        checkboxesAll = [...question.querySelectorAll('input[type="checkbox"]')];        
        
        var tempArray = [];
        for ( var i = 0; i < data.answer.length; i++ ) { 
            var option = questionData['options'].find(x => x.value == data.answer[i]);
            var checkbox = checkboxesAll.find(x => x.name == data.answer[i]);
            if(checkbox !== undefined) {
                var answer = { value: option['value'], nextQuestionId: option['nextQuestionId'] };
                tempArray.push(answer);
                checkbox.classList.remove("quiz-multiSelect-card-container");
                checkbox.classList.add("quiz-multiSelect-card-container-selected");
                $(checkbox).prop('checked', true);
            }
            answers = [...tempArray]
        }

        setNextLinkValues();
    }

    function _createMultiSelectItems(options) {
        var gridDiv = document.createElement("div");
        gridDiv.classList.add("quiz-multiSelect-container");
        for (var i = 0; i < options.length; i++) {
            var cardDiv = document.createElement("div");
            cardDiv.classList.add("quiz-multiSelect-card-container");
            cardDiv.append(_createMultiselctCardTitle(options[i]['title']));
            cardDiv.append(_createParagraphs(options[i]['paragraphs']));
            cardDiv.append(_createMultiselctCardCheckbox(options[i]));
            gridDiv.append(cardDiv);
        }
        return gridDiv;
    }

    function _createMultiselctCardTitle(title) {
        var titleDiv = document.createElement("div");
        titleDiv.classList.add("quiz-multiSelect-card-title-text");
        titleDiv.textContent = title;
        return titleDiv;  
    }

    function _createMultiselctCardCheckbox(option) {
        var checkboxDiv = document.createElement("div");
        checkboxDiv.classList.add("quiz-multiSelect-card-check-container");        
        
        var checkbox = document.createElement("INPUT");
        checkbox.setAttribute("type", "checkbox");
        checkbox.name = option['value'];
        checkbox.value = option['nextQuestionId'];

        $(checkbox).off().on('click', setMultiSelectAnswers.bind(this, option, checkbox));
        $(checkbox).on('click',function() {
            setMultiSelectAnswers.bind(this, option, checkbox);
            $(this).off('click');
        });

        checkboxDiv.appendChild(checkbox);
        return checkboxDiv;  
    }

    function setMultiSelectAnswers(option, checkbox) {
        $(checkbox).change(function() {
            if(this.checked) {
                nextQuestionId = option['nextQuestionId'];

                if(option['url'] !== "") {
                    nextQuestionId = option['url'];
                }
                else {
                    nextQuestionId = option['nextQuestionId'];
                }

                var answer = { value: option['value'], nextQuestionId: nextQuestionId };
                answers.push(answer);
                
                var selectedCheckbox = checkbox.closest(".quiz-multiSelect-card-container");
                selectedCheckbox.classList.remove("quiz-multiSelect-card-container");
                selectedCheckbox.classList.add("quiz-multiSelect-card-container-selected");
            }
            else {
                var selectedCheckbox = checkbox.closest(".quiz-multiSelect-card-container-selected");
                selectedCheckbox.classList.remove("quiz-multiSelect-card-container-selected");
                selectedCheckbox.classList.add("quiz-multiSelect-card-container");
                var index = answers.findIndex(x => x.value === option['value']);
                answers.splice(index, 1);
                if(answers.length === 0) {
                    nextQuestionId = -1;
                }
                else {
                    nextQuestionId = answers[0]['nextQuestionId'];
                }
            }
            if(nextQuestionId !== 9999) {
                checkConditionals();
            }
            setNextLinkValues();
        });
    }

    function checkConditionals() {
        if(conditionals.length !==0) {
            for ( var i = 0; i < conditionals.length; i++ ) { 
                var hasValue1 = answers.some( x => x.value == parseInt(conditionals[i]['value1']));
                var hasValue2 = answers.some( x => x.value == parseInt(conditionals[i]['value2']));
                if(hasValue1 && hasValue2) {
                    nextQuestionId = parseInt(conditionals[i]['nextQuestionId']);
                    return;
                }
            }
        }
    }
    
    ////////////////////////////
    // Single-select card elements
    ////////////////////////////
    // Creates cards with radio buttons
    function _createSingleSelectCardQuestion(questionData) {
        var question = document.createElement("div");
        question.classList.add("quiz-question");
        question.append(_createTitle(questionData['content']['title']));
        question.append(_createParagraphs(questionData['content']['paragraphs']));
        question.append(_createSingleSelectCardItems(questionData['options']));
        question.append(_createNextStepLink());
        $('#quiz-questions-container').empty();
        $('#quiz-questions-container').append(question);

        let data = questionHistory.find(x => x.question === currentQuestion);
        var radios = [];
        radios = [...question.querySelectorAll('input[type="radio"]')];        

        for ( var i = 0; i < data.answer.length; i++ ) { 
            var radio = radios.find(x => x.name == data.answer[i]);
            if(radio !== undefined) {
                answers[0] = data.answer[i];
                $(radio).prop('click', true);
            }
        }
        setNextLinkValues();
    }

    function _createSingleSelectCardItems(options) {
        var gridDiv = document.createElement("div");
        gridDiv.classList.add("quiz-multiSelect-container");
        for (var i = 0; i < options.length; i++) {
            if((options[i]['title']) != "") {
                var cardDiv = document.createElement("div");
                cardDiv.classList.add("quiz-multiSelect-card-container");
                cardDiv.append(_createMultiselctCardTitle(options[i]['title']));
                cardDiv.append(_createParagraphs(options[i]['paragraphs']));
                cardDiv.append(_createSingleSelectCardRadioButtons(options[i]));
                gridDiv.append(cardDiv);
            }
        }
        return gridDiv;
    }

    function _createSingleSelectCardRadioButtons(option) {
        var div = document.createElement("div");
        div.classList.add("quiz-singleSelectRadio-container");
        var label = document.createElement("label");
        var radio = document.createElement("input");
        radio.type = "radio";
        radio.name = option['value'];
        radio.value = option['nextQuestionId'];

        $(radio).off().on('click', setSingleSelectCardAnswer.bind(this, option, radio));
        $(radio).on('click',function() {
            setSingleSelectCardAnswer.bind(this, option, radio);
            $(this).off('click');
        });
        
        label.textContent = option.title
        div.appendChild(radio);
        div.appendChild(label);

        return div;
    }

    function setSingleSelectCardAnswer(option) {
        answers.push(option.optionId);
        nextQuestionId = option.nextQuestionId;
        setNextLinkValues();
    }

    ////////////////////////////
    // Single-selection elements
    ////////////////////////////
    // Creates a single select question card: two or more radio buttons
    function _createSingleSelectQuestion(questionData) {
        var question = document.createElement("div");
        question.classList.add("quiz-question");
        question.append(_createTitle(questionData['content']['title']));
        question.append(_createParagraphs(questionData['content']['paragraphs']));
        question.append(_createSingleSelectItems(questionData['options']));
        question.append(_createNextStepLink());
        $('#quiz-questions-container').empty();
        $('#quiz-questions-container').append(question);

        SetAnsweredRadioState(question);
        setNextLinkValues();
    }

    function _createSingleSelectItems(options) {
        var gridDiv = document.createElement("div");
        // gridDiv.id = "singleSelectItems-container";
        gridDiv.classList.add("quiz-singleSelectItems-container");
        for ( var i = 0; i < options.length; i++ ) {
            if(options[i]["optionId"] !== -1) { 
                gridDiv.append(_createRadioButtons(options[i]));
            }
        }
        return gridDiv;
    }

    function _createRadioButtons(option) {
        var singleRadioLabel = document.createElement("label");
        singleRadioLabel.classList.add("optionLabel");
        singleRadioLabel.id = "labelId-" + option['optionId'];
        var labelText = document.createElement("span");
        var radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "radio";
        radio.id = "inputId-" + option['value'];
        radio.value = option['nextQuestionId'];

        $(radio).off().on('click', setSingleSelectAnswers.bind(this, option, radio));
        $(radio).on('click',function() {
            setSingleSelectAnswers.bind(this, option, radio);
            $(this).off('click');
        });
        
        labelText.textContent = option.title
        singleRadioLabel.appendChild(radio);
        singleRadioLabel.appendChild(labelText);

        return singleRadioLabel;
    }

    function setSingleSelectAnswers(option) {
        answers = [];
        answers.push(option.value);
        nextQuestionId = option.nextQuestionId;
        setNextLinkValues();
    }

    //////////////////
    // Yes/No elements
    //////////////////
    // Creates a single select question card: two or more radio buttons
    function _createYesNoQuestion(questionData) {
        var question = document.createElement("div");
        question.classList.add("quiz-question");
        question.append(_createTitle(questionData['content']['title']));
        question.append(_createParagraphs(questionData['content']['paragraphs']));
        question.append(_createYesNoItems(questionData['options']));
        question.append(_createNextStepLink());
        $('#quiz-questions-container').empty();
        $('#quiz-questions-container').append(question);
        
        SetAnsweredRadioState(question);
        setNextLinkValues();
    }

    function _createYesNoItems(options) {
        var buttonDiv = document.createElement("div");
        buttonDiv.classList.add("btn-group");
        for ( var i = 0; i < options.length; i++ ) {
            if(options[i]["optionId"] !== -1) { 
                buttonDiv.append(_createYesNoButtons(options[i]));
            }
        }
        return buttonDiv;
    }

    function _createYesNoButtons(option) {
        var button = document.createElement("div");
        button.classList.add("button");
        
        var radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "choices";
        radio.id = option['value'];
        radio.value = option['nextQuestionId'];

        var label = document.createElement("label");
        document
        var labeltext = document.createTextNode(option.title);
        label.appendChild(labeltext);

        button.append(radio);
        button.append(label);

        $(button).off().on('click', setYesNoAnswers.bind(this, option, button));
        $(button).on('click',function() {
            setYesNoAnswers.bind(this, option, button);
            $(this).off('click');
        });
 
        return button;
    }

    function setYesNoAnswers(option) {
        answers = [];
        answers.push(option.value);
        nextQuestionId = option.nextQuestionId;
        setNextLinkValues();
    }

    //////////////////
    // Common Elements
    //////////////////
    // Creates a bold title
    function _createTitle(title) {
        if(title == "") { return }
        var titleDiv = document.createElement("h1");
        titleDiv.classList.add("quiz-title-text");
        titleDiv.textContent = title;
        return titleDiv;
    }

    // Creates one or more paragraphs
    function _createParagraphs(paragraphs) {
        if(paragraphs == "") { return };
        
        var paragraphDiv = document.createElement("div");
        paragraphDiv.classList.add("quiz-paragraph-text");
        for ( var i = 0; i < paragraphs.length; i++ ) {
            if(paragraphs[i].paragraphText.includes("*")) {
                var bullets = paragraphs[i].paragraphText.replace("\n","").split("*")
                bullets = bullets.filter(n => n);
                var list = document.createElement("ul");
                for ( var j = 0; j < bullets.length; j++ ) {
                    var listItem = document.createElement("li");
                    listItem.textContent = bullets[j];
                    list.append(listItem);
                }
                paragraphDiv.append(list);
            }
            else {
                paragraphDiv.append(_createParagraphElement(paragraphs[0].paragraphText));
            }
        }
        return paragraphDiv;        
    }

    // Creates each paragraph text
    function _createParagraphElement(paragraphText) {
        var paragraphElement = document.createElement("p");
        paragraphElement.appendChild(document.createTextNode(paragraphText));
        return paragraphElement;
    }

    ///////////////////////////////////
    // Load and save answered questions
    ///////////////////////////////////
    function updateAnswers() {
        setCookie("answers", JSON.stringify(questionHistory), 365);
    }

    function geAnswers() {
        return getCookie('answers');
    }

    function answer() {
        return {
            "question": currentQuestion,
            "answer": answers,
            "nextQuestionId": nextQuestionId
        }
    }

    function SetAnsweredRadioState(question) {
        let data = questionHistory.find(x => x.question === currentQuestion);
        var radios = [];
        radios = [...question.querySelectorAll('input[type="radio"]')];        

        for ( var i = 0; i < data.answer.length; i++ ) { 
            var radio = radios.find(x => x.id == data.answer[i]);

        if(radio !== undefined) {
                answers[0] = data.answer[i];
                $(radio).prop('checked', true);
            }
        }
    }

    ///////////////////////////////////
    // Utilities
    ///////////////////////////////////
    function showRelatedForms() {
        setloanType(primaryRecomendation);
        setContent("loanforms");
    }

    function openURL(url) {
        window.open(url, '_blank');
    }

    function savePDF() {
        $(report).show();
        var HTML_Width = $(report).width();
        var HTML_Height = $(report).height();
        var top_left_margin = 15;
        var PDF_Width = HTML_Width + (top_left_margin * 2);
        var PDF_Height = (PDF_Width * 1.5) + (top_left_margin * 2);
        var canvas_image_width = HTML_Width;
        var canvas_image_height = HTML_Height;

        var totalPDFPages = Math.ceil(HTML_Height / PDF_Height) - 1;

        html2canvas(report).then((canvas) => {
            var imgData = canvas.toDataURL("image/png", 1.0);
            var pdf = new jsPDF('p', 'pt', [PDF_Width, PDF_Height]);
            pdf.addImage(imgData, 'PNG', top_left_margin, top_left_margin, canvas_image_width, canvas_image_height);
            for (var i = 1; i <= totalPDFPages; i++) { 
                pdf.addPage(PDF_Width, PDF_Height);
                pdf.addImage(imgData, 'PNG', top_left_margin, -(PDF_Height*i)+(top_left_margin*4),canvas_image_width,canvas_image_height);
            }
            $(report).hide();
            pdf.save("Loan Quiz Summary.pdf");
        });
    }
    
    function printPDF() {
        $(report).show();
        var myDiv = document.getElementById('report');
        var newWindow = window.open('', 'SecondWindow', 'toolbar=0,stat=0');
        newWindow.document.write('<html>');
        newWindow.document.write('<link rel="stylesheet" href="./css/quiz.css" type="text/css" media="all"/>');
        newWindow.document.write('<body>');
        var divContents = document.getElementById("report").innerHTML;
        newWindow.document.write(divContents);
        newWindow.document.write('</body></html>');
        newWindow.document.close();
        // newWindow.print();
        // 

        setTimeout(function () {
            newWindow.print();
            newWindow.close();
        },1000);
        
        $(report).hide();
        return true;
    }
    
</script>
<link href="css/walkthrough.css" rel="stylesheet">
<div id="main-content" id="body"> 
    <div class="container">
            <div class="row">
                <div class="primary-region medium-12">
                    <h1 class="primary-region__title" id="title-holder">
                        
                    </h1>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="farmers-landing-page row">
                <div class="primary-region medium-12">
                    <div class="primary-region__header">
                        <div  id="header-holder"> </div>
                        <p>
                            Below are the forms used to apply for for an annual operating farm loan. You may needs to fill many of them to complete your application. Please select a form to start the walk tough process. You may comeplete the form as you go though this process. You may download the each form to your computers at any point to save your progress and resume working on it later. Please note:
                        </p>
                        <ul>
                            <li>The forms can only be saved to your computer;</li>
                            <li>At no point in this process is any information saved to, or shared with USDA staff or systems; and</li>
                            <li>You care encouraged to reach out to your Local Service Center if you have any further questions or concerns.</li>
                        </ul>
                        <p id="return-form-suport">
                            
                        </p>

                        <!-- Yellow warning --> 
                        <div class="warning-container">
                            <div class="warning-left-bar"> </div>
                            <div class="warning-icon">
                                <img src="./images/alerts/warning.png" alt="warning icon" height="32" width="32">
                            </div>
                            <div class="warning-message">
                                <div class="warning-message-title">
                                    These forms can only be saved to your computer
                                </div>
                            </div>
                        </div>
                        
                        <!-- blue  info box --> 
                        <div class="info-container" id="info-container-id">
                            <div class="info-left-bar"> </div>
                            <div class="info-icon">
                                <img src="./images/alerts/info.png" alt="alert icon" height="32" width="32">
                            </div>
                            <div class="info-message">
                                <div class="info-message-title">
                                    Eligibility assesssment available
                                </div>
                                <div class="info-message-description">
                                    Not sure where to start? Complete the eligibility assessment to understand which loan application best suits your needs.
                                </div>
                                    <button class="btn lg-btn info-button-container" onclick="window.location.assign('/lrt.html')" aria-label="Go to the Loan Readiness Tool">
                                        Start Eligibility Self-Assessment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <div class="container">
        <div class="divider-line"></div>
    </div>

    <div class="container" id="search-status" style="display: none;">
        <div class="row">
            <div class="medium-6 text-right">
                <p>Showing <span id="show_count">0</span> out of <span id="total_count">0</span> forms.</p>
            </div>
            <div class="medium-6 text-left">
                <a id="show-all-link" href="/walkthrough.html" class="text-link">Show All</a>
            </div>
        </div>
        <div class="divider-dot"></div>
    </div>

    <div class="container">
        <div class="row row-cols-1 row-cols-md-3 g-4" id="forms-holder"></div>
    </div>


</div>

    <script>
        (function() {
            console.log("Walkthrough" + location.search);
            // Show loan specific Forms
            // Check if specific loan has been picked "?" indicates a specific loan has been picked.  Otherwise show all loans on a grid
            if(location.search.includes("?")){
                //  get loanType
                var loanType = location.search.replace("?",'');

                // Show Forms Grid with forms for specific loan type
                $.getJSON("/forms/forms.json", function(data) {
                    show_count = 0;
                    total_count = 0;

                    // Get the index of the loanType 
                    var index = data['LoanType'].findIndex(function(item, i){ return item.type === loanType; });
                    // Get the loan name
                    var loanName = data['LoanType'][index]['name'];

                    // Get search query 
                    let q = getQueryVar(name = "query");
                    if (q) {
                        search_val = q.toLowerCase();
                        $("#header-search").val(q);
                    }
                    else {
                        search_val = false;
                    }

                    const form_ids = getQueryVar(name = "show_forms");
                    if (form_ids) {
                        if (form_ids == "null") {
                            show_forms = false;
                        } else {
                            show_forms = form_ids.split(",");
                        }
                        $('#show_forms').val(form_ids);
                        $('#walkthrough-link').attr("href", `/walkthrough.html?show_forms=${form_ids}`);
                    } 
                    else {
                        show_forms = false;
                    }
                
                    // Title of support page
                    var titleText = `<div class="col">
                                        <div class="loantype-title">    
                                            <div class="">
                                                <a href="/walkthrough.html" data-label="/walkthrough.html" aria-label="Go to Form Support Page" data-category="Loans">
                                                    <img class="loantype-title-back image-flip" src="./images/arrow-right.png" alt="Back arrow" width="32">
                                                </a>
                                            </div>
                                            <div class="loantype-title-name">
                                                <div>${loanName} Form Support</div>
                                            </div>
                                        </div>
                                    </div>`;
                    document.getElementById('title-holder').innerHTML = titleText;
                    
                    // Description of support page
                    var descriptioText =    `<div class="col"> ${data['LoanType'][index]['description']} </div>`;
                    document.getElementById('header-holder').innerHTML = descriptioText;
                    
                    // The cards for the individual forms
                    var cards = [];
                    $.each(data["Forms"], function(key, form) {
                        // use index to get the list of forms for the loan type
                        // if not in the loan's form list reeturn without building card
                        if(!data['LoanType'][index]['forms'].includes(form['id'])) { return; }

                        if (show_forms) {
                            if ($.inArray(form["id"], show_forms) < 0) {
                                return;
                            }
                        }

                        // Search filter 
                        if (search_val) {
                            if ((form["name"].toLowerCase().indexOf(search_val) < 0) && (form["description"].toLowerCase().indexOf(search_val) < 0)) {
                                return;
                            }
                        }
                        
                        var new_card =  `<div class="col">
                                            <div class="content-card accent-top form-card h-100"">
                                                <div class="headline">
                                                    <h3><a class="text-link" href="/form.html?key=${key}&show_forms=${form_ids}">${form.name}</a></h3>
                                                </div>
                                                <div class="content">
                                                    <p> ${form["description"]} </p>
                                                </div>
                                                <div class="link">
                                                    <a class="text-link" href="/form.html?key=${key}&show_forms=${form_ids}">Get assistance completing this form</a>
                                                    <a class="text-link" href="/forms/${form["file_name"]}" download>Download</a>
                                                </div>
                                            </div>
                                        </div>`;
                        
                        cards.push(new_card);
                        total_count += 1;
                        show_count += 1;;
                    });

                    $("#forms-holder").append(cards.join(""));

                    $('#return-form-suport').html(`<a href="/walkthrough.html" class="page-link" data-label="/walkthrough.html" aria-label="Go to Form Support Page" data-category="Loans">Back to all loan types</a>`);

                    if (search_val) {
                        $('#show_count').html(show_count);
                        $('#total_count').html(total_count);
                        $('#show-all-link').attr("href", `/walkthrough.html?show_forms=${form_ids}`);
                        $('#search-status').show();
                    }
                    else { $('#search-status').hide(); }
                });
            }
            
            // Show all loan types
            else 
            { 
                $.getJSON("/forms/forms.json", function(data) {
                    show_count = 0;
                    total_count = 0;

                    // Get search query
                    // console.log(location.search);
                    // let q = getQueryVar(name = "query");

                    // console.log(q);
                    // if (q) {
                    //     search_val = q.toLowerCase();
                    //     $("#header-search").val(q);
                    // } else {
                    //     search_val = false;
                    // }

                    // const form_ids = getQueryVar(name = "show_forms");
                    // if (form_ids) {
                    //     if (form_ids == "null") {
                    //         show_forms = false;
                    //     } else {
                    //         show_forms = form_ids.split(",");
                    //     }
                    //     $('#show_forms').val(form_ids);
                    //     $('#walkthrough-link').attr("href", `/walkthrough.html?show_forms=${form_ids}`);
                    // } else {
                    //     show_forms = false;
                    // }

                    var cards = [];

                    $.each(data["LoanType"], function(key, type) {
                        /* SEARCH FORMS
                        // Form filter ?show_forms=FORM_ID,FORM_ID If form_ids is missing or empty show all.
                        // if (show_forms) {
                        //     if ($.inArray(type["id"], show_forms) < 0) {
                        //         return
                        //     }
                        // }

                        // // Search filter 
                        // if (search_val) {
                        //     if ((type["name"].toLowerCase().indexOf(search_val) < 0) && (type["description"].toLowerCase().indexOf(search_val) < 0)) {
                        //         return
                        //     }
                        // }
                        */
                        
                        // Title of support page
                        var titleText = `<div class="col"> Farm Loan Application Form Support </div>`
                        document.getElementById('title-holder').innerHTML = titleText;
                        
                        // Card for each loan type
                        var new_card = `<div class="col">
                                            <div class="loantype-card-container">
                                                <div class="loantype-card-image-container">
                                                    <img class="loantype-card-image-container" src="./images/loantypes/${type["image"]}" alt="${type["imageAltText"]}">
                                                </div>
                                                <div class="loantype-card-title">
                                                    <h3> ${type["name"]} </h3>
                                                </div>
                                                <div class="loantype-card-description">
                                                    <p> ${type["description"]} </p>
                                                </div>
                                                <div class="loantype-card-spacer">
                                                    <p></p>
                                                </div> 
                                                <div class="loantype-card-button-container">
                                                    <div class="loantype-card-button">
                                                        <button class="btn lg-btn" onclick="setCookie('currentLoanType', '${type["type"]}', 1);window.location.assign('/walkthrough.html?${type["type"]}')" aria-label="Go to the ${type["type"]}" data-category="${type["type"]}"> ACCESS FORMS </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>`;
                        cards.push(new_card);
                        total_count += 1;
                        show_count += 1;
                    });

                    $("#forms-holder").append(cards.join(""));
                    $('#search-status').hide();
                });
            }
        })();

        // After DOM is loaded
        $(document).ready(function () {
            // Hide info if Eligibility Self-Assessment not complete
            if(userState() != 2) {
                document.getElementById('info-container-id').style.display = 'grid';  
            }
        });
    </script>